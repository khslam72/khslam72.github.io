name: Submit Selected URLs to Google Indexing API

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose which posts to index"
        required: true
        type: choice
        options:
          - today
          - yesterday
          - manual
      manual_urls:
        description: "If manual mode: enter one or more URLs separated by spaces"
        required: false
        default: ""

jobs:
  indexing:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Seoul"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚úÖ Google Cloud Ïù∏Ï¶ù
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.SERVICE_ACCOUNT_KEY }}'

      # ‚úÖ gcloud ÏÑ∏ÏÖò ÌôúÏÑ±Ìôî (ÌôòÍ≤ΩÎ≥ÄÏàò Ïú†ÏßÄ)
      - name: Activate gcloud SDK session
        run: |
          echo "üîë Activating service account..."
          export GOOGLE_APPLICATION_CREDENTIALS="${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth activate-service-account --key-file="${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth list

      # ‚úÖ ÏÉâÏù∏ ÎåÄÏÉÅ URL ÏàòÏßë
      - name: Determine URLs to index
        id: get_urls
        run: |
          MODE="${{ github.event.inputs.mode }}"
          URLS=""

          if [ "$MODE" == "today" ]; then
            echo "üïí Mode: today - finding posts modified in the last 1 day"
            FILES=$(find _posts -type f -mtime -1)
          elif [ "$MODE" == "yesterday" ]; then
            echo "üïí Mode: yesterday - finding posts modified 1‚Äì2 days ago"
            FILES=$(find _posts -type f -mtime 1)
          elif [ "$MODE" == "manual" ]; then
            echo "üìù Manual mode - using input URLs"
            URLS="${{ github.event.inputs.manual_urls }}"
          fi

          if [ "$MODE" != "manual" ]; then
            for file in $FILES; do
              FILENAME=$(basename "$file" .md)
              TITLE_PART=$(echo "$FILENAME" | cut -d'-' -f4-)
              URL="https://kcontents.site/${TITLE_PART}/"
              URLS="$URLS $URL"
            done
          fi

          echo "URLs to index: $URLS"
          echo "URLS_TO_INDEX=$URLS" >> $GITHUB_ENV

      # ‚úÖ Google Indexing API Ï†úÏ∂ú
      - name: Submit to Google Indexing API
        if: env.URLS_TO_INDEX != ''
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="${GOOGLE_APPLICATION_CREDENTIALS}"
          for url_to_index in ${{ env.URLS_TO_INDEX }}; do
            echo "Submitting: $url_to_index"
            ACCESS_TOKEN=$(gcloud auth print-access-token --scopes="https://www.googleapis.com/auth/indexing")

            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST "https://indexing.googleapis.com/v3/urlNotifications:publish" \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "{ \"url\": \"$url_to_index\", \"type\": \"URL_UPDATED\" }")

            CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$CODE" -eq 200 ]; then
              echo "‚úÖ Successfully submitted: $url_to_index"
            else
              echo "‚ùå Error submitting: $url_to_index (HTTP $CODE)"
              echo "‚Ü≥ Response body:"
              echo "$BODY"
            fi
          done
