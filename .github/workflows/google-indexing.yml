name: Submit to Google Indexing API

on:
  # ✅ "Run workflow" 버튼을 추가하기 위한 설정
  workflow_dispatch:

  # 기존의, 새 글이 올라올 때 자동으로 실행되는 설정
  push:
    branches:
      - master
    paths:
      - '_posts/**.md'

jobs:
  indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get post URLs
        id: get_urls
        run: |
          URLS=""
          # ✅ 수동으로 실행했는지, 자동으로 실행됐는지 확인
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger: Processing all posts."
            FILES=$(find _posts -name "*.md") # 모든 글 목록 가져오기
          else
            echo "Push trigger: Processing changed posts."
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^_posts/.*\.md$") # 변경된 글만 가져오기
          fi

          for file in $FILES; do
            FILENAME=$(basename "$file" .md)
            TITLE_PART=$(echo "$FILENAME" | cut -d'-' -f4-)
            # This matches the permalink: /:title/
            URL="https://kcontents.site/${TITLE_PART}/"
            URLS="$URLS $URL"
          done
          echo "URLS_TO_INDEX=$URLS" >> $GITHUB_ENV
          echo "Found URLs to index: $URLS"

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.SERVICE_ACCOUNT_KEY }}'

      - name: Submit URLs (debug mode)
  if: env.URLS_TO_INDEX != ''
  run: |
    for url_to_index in ${{ env.URLS_TO_INDEX }}; do
      echo "Submitting: $url_to_index"
      response=$(curl -s -w "\n%{http_code}" -X POST "https://indexing.googleapis.com/v3/urlNotifications:publish" \
        -H "Authorization: Bearer $(gcloud auth print-access-token)" \
        -H "Content-Type: application/json" \
        --data '{ "url": "'$url_to_index'", "type": "URL_UPDATED" }')
      echo "Google API response:"
      echo "$response"
    done

